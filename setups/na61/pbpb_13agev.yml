_layouts:
  - &layout-na61-psd1
    [ 0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15 ]
  - &layout-na61-psd2
    [ 16,17,18,19,20,21,22,23,24,25,26,27 ]
  - &layout-na61-psd3
    [ 28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43 ]

_axes:
  - &ax-centrality {name: Centrality/Centrality_Epsd, nb: 20, lo: 0, hi: 100}
  - &ax-pt {name: RecParticles/pT, bin-edges: [0., 0.2, 0.4, 0.6, 0.8, 1.0, 1.2, 1.4, 1.8, 2.2, 2.6, 3.0]}
#efficiency map for pions is defined in [0, 1.5] GeV
  - &ax-pt-corr-protons {name: RecParticles/pT, nb: 1, lo: 0., hi: 1.5}
#efficiency map for pions is defined in [0, 1] GeV
  - &ax-pt-corr-pions {name: RecParticles/pT, nb: 1, lo: 0., hi: 1.}
  - &ax-y-cm {name: RecParticles/y_cm, nb: 15, lo: -0.6, hi: 2.4}
  - &ax-y-cm-corr-1 {name: RecParticles/y_cm, nb: 1, lo: 0., hi: 1.2}
  - &ax-y-cm-corr-2 {name: RecParticles/y_cm, nb: 3, lo: 0., hi: 1.2}

_cuts:
  - &rec-particle-cuts-quality-standard
    RecParticles/nhits_total : { range: [30, 1000] }
    RecParticles/nhits_vtpc : { range: [10, 1000] }
    RecParticles/nhits_pot_total : { range: [1, 1000] }
    RecParticles/nhits_ratio : { range: [0.55, 1.1] }
    RecParticles/dcax : { range: [-2., 2.] }
    RecParticles/dcay : { range: [-1., 1.] }
  - &rec-particle-cuts-quality-dca-tight
    _from: *rec-particle-cuts-quality-standard
    RecParticles/dcax : { range: [-1, 1.] }
    RecParticles/dcay : { range: [-0.5, 0.5] }
  - &rec-particle-cuts-quality-dca-loose
    _from: *rec-particle-cuts-quality-standard
    RecParticles/dcax: { range: [ -3, 3. ] }
    RecParticles/dcay: { range: [ -1.5, 1.5 ] }
  - &rec-particle-cuts-quality-nhits-vtpc-loose
    _from: *rec-particle-cuts-quality-standard
    RecParticles/nhits_vtpc : { range: [5, 1000] }
  - &rec-particle-cuts-quality-nhits-vtpc-tight
    _from: *rec-particle-cuts-quality-standard
    RecParticles/nhits_vtpc : { range: [15, 1000] }
  - &rec-particle-cuts-quality-nhits-total-loose
    _from: *rec-particle-cuts-quality-standard
    RecParticles/nhits_total : { range: [20, 1000] }
  - &rec-particle-cuts-quality-nhits-total-tight
    _from: *rec-particle-cuts-quality-standard
    RecParticles/nhits_total : { range: [40, 1000] }
  - &rec-particle-cuts-quality-nhits-ratio-lowedge-tight
    _from: *rec-particle-cuts-quality-standard
    RecParticles/nhits_ratio : { range: [0.7, 1.1] }
  - &rec-particle-cuts-quality-nhits-ratio-lowedge-loose
    _from: *rec-particle-cuts-quality-standard
    RecParticles/nhits_ratio : { range: [0.4, 1.1] }
  - &rec-particle-cuts-quality-nhits-ratio-upedge-tight
    _from: *rec-particle-cuts-quality-standard
    RecParticles/nhits_ratio : { range: [0.55, 1.0] }




_qa:
  - &psd-qa
    - { name: PsdModules/phi, nb: 100, lo: -4., hi: 4. }
    - { name: PsdModules/signal, nb: 100, lo: 0., hi: 100. }
  - &rec-particle-qa-kinematics
    - &ax-phi-qa { name: RecParticles/phi, nb: 400, lo: -4., hi: 4.}
    - &ax-pt-qa { name: RecParticles/pT, nb: 1000, lo: 0., hi: 2. }
    - &ax-pz-qa { name: RecParticles/pz, nb: 1000, lo: 0., hi: 20.}
    - &ax-rapidity-qa { name: RecParticles/y_cm, nb: 1000, lo: -4., hi: 4. }
    - &ax-eta-qa { name: RecParticles/eta, nb: 1000, lo: -2., hi: 6. }
    - [*ax-rapidity-qa, *ax-pt-qa]
    - [*ax-eta-qa, *ax-pt-qa]
    - [*ax-phi-qa, *ax-rapidity-qa]
    - [*ax-phi-qa, *ax-pt-qa]
  - &rec-particle-qa-kinematics-weighted
    - { axes: [*ax-rapidity-qa], weight: RecParticles_w_eff_standard_cuts }
    - { axes: [*ax-pt-qa], weight: RecParticles_w_eff_standard_cuts }
    - { axes: [*ax-phi-qa], weight: RecParticles_w_eff_standard_cuts }
    - { axes: [*ax-rapidity-qa, *ax-pt-qa], weight: RecParticles_w_eff_standard_cuts }
    - { axes: [*ax-phi-qa, *ax-pt-qa], weight: RecParticles_w_eff_standard_cuts }
    - { axes: [*ax-phi-qa, *ax-rapidity-qa], weight: RecParticles_w_eff_standard_cuts }
  - &rec-particle-qa-quality
    - &ax-dcax-qa { name: RecParticles/dcax, nb: 200, lo: -10, hi: 10 }
    - &ax-dcay-qa { name: RecParticles/dcay, nb: 200, lo: -10, hi: 10 }
    - [*ax-dcax-qa, *ax-dcay-qa]
    - &ax-nhits-vtpc-qa { name: RecParticles/nhits_vtpc, nb: 300, lo: 0, hi: 300 }
    - &ax-nhits-total-qa { name: RecParticles/nhits_total, nb: 300, lo: 0, hi: 300 }
    - &ax-nhits-pot-total-qa { name: RecParticles/nhits_pot_total, nb: 300, lo: 0, hi: 300 }
    - [*ax-nhits-pot-total-qa, *ax-nhits-total-qa]


########################################################################################
#   CORRECTION
########################################################################################
pbpb_13agev_16_025:
  event-variables:
    - Centrality/Centrality_Epsd
    - RecEventHeader/vtx_x
    - RecEventHeader/vtx_y
    - RecEventHeader/vtx_z
    - RecEventHeader/Epsd
    - RecEventHeader/s1
    - RecEventHeader/s2
  qa:
    - &ax-vtx-x-qa { name: RecEventHeader/vtx_x, nb: 1000, lo: -10., hi: 10}
    - &ax-vtx-y-qa { name: RecEventHeader/vtx_y, nb: 1000, lo: -10., hi: 10}
    - [*ax-vtx-x-qa, *ax-vtx-y-qa]
    - &ax-vtx-z-qa { name: RecEventHeader/vtx_z, nb: 1000, lo: -602., hi: -582.}
    - &ax-epsd-qa { name: RecEventHeader/Epsd, nb: 500, lo: 0, hi: 5000}
    - *ax-centrality
    - [*ax-epsd-qa, *ax-centrality]
    - [*ax-vtx-z-qa, *ax-epsd-qa]
    - [*ax-vtx-z-qa, *ax-centrality]
    - &ax-s1-qa { name: RecEventHeader/s1, nb: 500, lo: 0, hi: 500}
    - &ax-s2-qa { name: RecEventHeader/s2, nb: 500, lo: 0, hi: 500}
    - [*ax-s1-qa, *ax-s2-qa]
    - [*ax-s1-qa, *ax-epsd-qa]
    - [*ax-s2-qa, *ax-epsd-qa]
  axes: [ *ax-centrality ]
  q-vectors: &q-vectors-list
# OBSERVABLES
# STANDARD CUTS
    - name: protons_pt_standard
      tags: [observable]
      _from: &tpc-base-detector
        type: track
        phi: RecParticles/phi
        weight: Ones
        norm: m
        corrections:
          - recentering
          - twist-and-rescale
        qa-quality: *rec-particle-qa-quality
        qa-kinematics: *rec-particle-qa-kinematics
      axes: &correction-axes-pt-standard
        - *ax-pt
        - *ax-y-cm-corr-1
      cuts-quality: *rec-particle-cuts-quality-standard
      cuts: &cuts-proton
        RecParticles/pid : { equals: 2212 }
    - name: protons_y_standard
      tags: [observable]
      _from: *tpc-base-detector
      axes: &correction-axes-y-proton-standard
        - *ax-y-cm
        - *ax-pt-corr-protons
      cuts-quality: *rec-particle-cuts-quality-standard
      cuts: *cuts-proton
    - name: pion_neg_pt_standard
      tags: [observable]
      _from: *tpc-base-detector
      axes: *correction-axes-pt-standard
      cuts-quality: *rec-particle-cuts-quality-standard
      cuts: &cuts-pion-neg
        RecParticles/pid : { equals: -211 }
    - name: pion_neg_y_standard
      tags: [observable]
      _from: *tpc-base-detector
      axes: *correction-axes-y-proton-standard
      cuts-quality: *rec-particle-cuts-quality-standard
      cuts: *cuts-pion-neg
# STANDARD CUTS (WEIGHTED)
    - name: protons_pt_standard_weighted
      tags: [ observable ]
      _from: &tpc-base-detector-weighted
        type: track
        phi: RecParticles/phi
        weight: RecParticles/w_eff_standard_cuts
        norm: m
        corrections:
          - recentering
          - twist-and-rescale
        qa-quality: *rec-particle-qa-quality
        qa-kinematics: *rec-particle-qa-kinematics
        qa-special: *rec-particle-qa-kinematics-weighted
      axes: &correction-axes-pt-standard
        - *ax-pt
        - *ax-y-cm-corr-1
      cuts-quality: *rec-particle-cuts-quality-standard
      cuts: &cuts-proton
        RecParticles/pid: { equals: 2212 }
    - name: protons_y_standard_weighted
      tags: [ observable ]
      _from: *tpc-base-detector-weighted
      axes: &correction-axes-y-proton-standard
        - *ax-y-cm
        - *ax-pt-corr-protons
      cuts-quality: *rec-particle-cuts-quality-standard
      cuts: *cuts-proton
    - name: pion_neg_pt_standard_weighted
      tags: [ observable ]
      _from: *tpc-base-detector-weighted
      axes: *correction-axes-pt-standard
      cuts-quality: *rec-particle-cuts-quality-standard
      cuts: &cuts-pion-neg
        RecParticles/pid: { equals: -211 }
    - name: pion_neg_y_standard_weighted
      tags: [ observable ]
      _from: *tpc-base-detector-weighted
      axes: &correction-axes-y-pion-standard
        - *ax-y-cm
        - *ax-pt-corr-pions
      cuts-quality: *rec-particle-cuts-quality-standard
      cuts: *cuts-pion-neg
# REFERENCE DETECTORS
    - name: psd1
      tags: [reference]
      _from: &reference-base-detector
        type: channel
        phi: PsdModules/phi
        weight: PsdModules/signal
        norm: m
        corrections: [ recentering ]
        qa: *psd-qa
      channel-ids: *layout-na61-psd1
    - name: psd2
      tags: [reference]
      _from: *reference-base-detector
      channel-ids: *layout-na61-psd2
    - name: psd3
      tags: [reference]
      _from: *reference-base-detector
      channel-ids: *layout-na61-psd3

########################################################################################
#   CORRELATION
########################################################################################

_axes_analysis:
  - &ax-centrality-analysis
    name: Centrality_Centrality_Epsd
    bin-edges: [ 0., 5., 10., 15., 25., 35., 45., 60., 80., 100. ]

_tasks:
  - args:
      - query: { tags: { any-in: [ observable ] } }
        query-list: *q-vectors-list
        components: &x1y1 [x1, y1]
        correction-steps: [ recentered, rescaled ]
        weight: sumw
      - query: { tags: { any-in: [ reference ] } }
        query-list: *q-vectors-list
        components: *x1y1
        correction-steps: [ recentered ]
        weight: ones
    # temporarily ignored
    #    actions: [xx,xy,yx,yy]
    n-samples: 50
    weights-type: observable
    # temporarily ignored
    #    weights-function: xx
    folder: "/uQ"
    axes: [ *ax-centrality-analysis ]
  - args:
      - query: { tags: { any-in: [ reference ] } }
        query-list: *q-vectors-list
        components: *x1y1
        correction-steps: [ recentered ]
        weight: ones
      - query: { tags: { any-in: [ reference ] } }
        query-list: *q-vectors-list
        components: *x1y1
        correction-steps: [ recentered ]
        weight: ones
    # temporarily ignored
    #    actions: [xx,xy,yx,yy]
    n-samples: 50
    weights-type: reference
    # temporarily ignored
    #    weights-function: xx
    folder: "/QQ"
    axes: [ *ax-centrality-analysis ]
